<%- include('../partials/head.ejs', { title }) %>
<%- include('../partials/header.ejs') %>
<%- include('../partials/nav.ejs', { nav }) %>

<main id="main" class="container" tabindex="-1">
  <h1><%= title %></h1>

  <!-- Flash messages -->
  <div id="messages" aria-live="polite"><%- (typeof messages === 'function') ? messages() : '' %></div>

  <!-- Validation errors (from either form) -->
  <% if (errors && typeof errors.array === 'function' && errors.array().length) { %>
    <ul class="notice" aria-live="polite">
      <% errors.array().forEach(err => { %>
        <li><%= err.msg %></li>
      <% }) %>
    </ul>
  <% } %>

  <!-- Account Update Form -->
  <section aria-labelledby="acct-update-heading" style="margin-top:1rem">
    <h2 id="acct-update-heading">Account Update</h2>
    <p class="form-hint">Update your name or email and save your changes.</p>

    <form action="/account/update" method="post" class="form">
      <div class="form-row">
        <label for="account_firstname">First name</label>
        <input
          type="text"
          id="account_firstname"
          name="account_firstname"
          required
          maxlength="50"
          autocomplete="given-name"
          inputmode="text"
          value="<%= typeof account_firstname !== 'undefined' ? account_firstname : '' %>"
          autofocus
        />
      </div>

      <div class="form-row">
        <label for="account_lastname">Last name</label>
        <input
          type="text"
          id="account_lastname"
          name="account_lastname"
          required
          maxlength="50"
          autocomplete="family-name"
          inputmode="text"
          value="<%= typeof account_lastname !== 'undefined' ? account_lastname : '' %>"
        />
      </div>

      <div class="form-row">
        <label for="account_email">Email</label>
        <input
          type="email"
          id="account_email"
          name="account_email"
          required
          maxlength="254"
          autocomplete="email"
          inputmode="email"
          value="<%= typeof account_email !== 'undefined' ? account_email : '' %>"
          aria-describedby="emailHelp"
        />
        <p id="emailHelp" class="form-hint">Weâ€™ll use this email to contact you.</p>
      </div>

      <input type="hidden" name="account_id" value="<%= account_id %>" />

      <button class="btn primary" type="submit">Save Changes</button>
      <a class="btn outline" href="/account">Cancel</a>
    </form>
  </section>

  <hr style="margin:2rem 0;border:none;border-top:1px solid var(--border);" />

  <!-- Change Password Form -->
  <section aria-labelledby="pw-change-heading">
    <h2 id="pw-change-heading">Change Password</h2>
    <p class="form-hint">
      Use at least 12 characters, including upper &amp; lower case letters, a number, and a symbol.
    </p>

    <form action="/account/update-password" method="post" class="form">
      <div class="form-row">
        <label for="account_password">New password</label>
        <input
          type="password"
          id="account_password"
          name="account_password"
          required
          minlength="12"
          autocomplete="new-password"
          pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{12,}"
          aria-describedby="pwHelp"
        />
        <button type="button" class="btn" id="togglePw" aria-controls="account_password" aria-pressed="false">Show</button>
        <p id="pwHelp" class="form-hint">
          Minimum 12 characters, with at least one uppercase, one lowercase, one number, and one symbol.
        </p>
      </div>

      <input type="hidden" name="account_id" value="<%= account_id %>" />

      <button class="btn primary" type="submit">Change Password</button>
      <a class="btn outline" href="/account">Cancel</a>
    </form>
  </section>
</main>

<%- include('../partials/footer.ejs') %>

<script>
  // Simple show/hide for password field
  (function () {
    const pw = document.getElementById('account_password');
    const btn = document.getElementById('togglePw');
    if (!pw || !btn) return;
    btn.addEventListener('click', () => {
      const isPwd = pw.getAttribute('type') === 'password';
      pw.setAttribute('type', isPwd ? 'text' : 'password');
      btn.textContent = isPwd ? 'Hide' : 'Show';
      btn.setAttribute('aria-pressed', String(isPwd));
    });
  })();
</script>
